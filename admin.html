<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🔬</text></svg>">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="theme-color" content="#000000">
  <meta name="description" content="PathLab Connect - Professional Lab Management System">
  <title>PathLab Connect - Admin Dashboard</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <style>
    /* EXACT SAME GUI STYLES - NO CHANGES */
    .bg-gradient-neumorphism {
      background: linear-gradient(145deg, #e8e8e8, #ffffff);
    }
    
    .shadow-neumorphism {
      box-shadow: 20px 20px 40px #c5c5c5, -20px -20px 40px #ffffff;
    }
    
    .shadow-neumorphism-inset {
      box-shadow: inset 20px 20px 40px #c5c5c5, inset -20px -20px 40px #ffffff;
    }
    
    .shadow-neumorphism-sm {
      box-shadow: 10px 10px 20px #c5c5c5, -10px -10px 20px #ffffff;
    }
    
    .shadow-neumorphism-inset-sm {
      box-shadow: inset 10px 10px 20px #c5c5c5, inset -10px -10px 20px #ffffff;
    }
    
    .neumorph-card {
      background: #e8e8e8;
      border-radius: 20px;
    }
    
    .neumorph-button {
      background: linear-gradient(145deg, #f0f0f0, #cacaca);
      border: none;
      border-radius: 12px;
      transition: all 0.2s ease;
      cursor: pointer;
    }
    
    .neumorph-input {
      background: #e8e8e8;
      border: none;
      border-radius: 12px;
    }
    
    .appointment-card {
      background: #e8e8e8;
      transition: all 0.2s ease;
      cursor: pointer;
      border-radius: 16px;
    }
    
    .appointment-card:hover {
      box-shadow: 5px 5px 10px #c5c5c5, -5px -5px 10px #ffffff;
    }
    
    .appointment-card.selected {
      background: #dbeafe;
      box-shadow: inset 10px 10px 20px #c5c5c5, inset -10px -10px 20px #ffffff;
    }
    
    .status-received { background: #dbeafe; color: #1e40af; }
    .status-contacted { background: #fef3c7; color: #d97706; }
    .status-confirmed { background: #d1fae5; color: #065f46; }
    .status-completed { background: #dcfce7; color: #166534; }
    .status-cancelled { background: #fee2e2; color: #991b1b; }
    .status-pending { background: #fef3c7; color: #d97706; }
    
    /* PRESCRIPTION VIEWER STYLES - NEW ADDITION */
    .prescription-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 10000;
      backdrop-filter: blur(4px);
    }
    
    .prescription-modal.show {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .prescription-viewer {
      background: white;
      border-radius: 16px;
      max-width: 90vw;
      max-height: 90vh;
      overflow: auto;
      position: relative;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
    }
    
    .prescription-image {
      max-width: 100%;
      max-height: 80vh;
      object-fit: contain;
      border-radius: 12px;
    }
    
    .prescription-placeholder {
      background: #f8fafc;
      border: 2px dashed #cbd5e0;
      border-radius: 12px;
      padding: 40px;
      text-align: center;
      color: #64748b;
    }
    
    .patient-detail-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }
    
    .patient-detail-item {
      background: #f8fafc;
      padding: 12px;
      border-radius: 8px;
      border-left: 4px solid #3b82f6;
    }
    
    .patient-detail-label {
      font-size: 12px;
      font-weight: 600;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }
    
    .patient-detail-value {
      font-size: 14px;
      font-weight: 500;
      color: #1e293b;
    }
  </style>
</head>

<body class="bg-gray-100">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useCallback } = React;

    // Login Component - EXACT SAME
    function LoginScreen({ onLogin }) {
      const [formData, setFormData] = useState({ email: '', password: '' });
      const [isLoading, setIsLoading] = useState(false);
      const [error, setError] = useState('');

      const handleSubmit = async (e) => {
        e.preventDefault();
        setIsLoading(true);
        setError('');

        try {
          const response = await fetch('/api/admin/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
          });

          const result = await response.json();

          if (result.success) {
              sessionStorage.setItem('adminSessionId', result.sessionId); // Use sessionId from login response
              setUser(result.user);
          } else {
            setError(result.message || 'Login failed');
          }
        } catch (error) {
          setError('Connection error. Please try again.');
        } finally {
          setIsLoading(false);
        }
      };

      return (
        <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-500 to-purple-600 p-4">
          <div className="neumorph-card shadow-neumorphism p-8 w-full max-w-md">
            <div className="text-center mb-8">
              <div className="text-4xl mb-4">🔬</div>
              <h1 className="text-3xl font-bold text-gray-800 mb-2">PathLab Connect</h1>
              <p className="text-gray-600">Admin Dashboard</p>
            </div>

            {error && (
              <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg mb-4">
                {error}
              </div>
            )}

            <form onSubmit={handleSubmit} className="space-y-6">
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-2">Email Address</label>
                <input
                  type="email"
                  className="neumorph-input shadow-neumorphism-inset-sm w-full px-4 py-3 text-gray-700 focus:outline-none"
                  placeholder="Enter your email"
                  value={formData.email}
                  onChange={(e) => setFormData({...formData, email: e.target.value})}
                  required
                />
              </div>

              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-2">Password</label>
                <input
                  type="password"
                  className="neumorph-input shadow-neumorphism-inset-sm w-full px-4 py-3 text-gray-700 focus:outline-none"
                  placeholder="Enter your password"
                  value={formData.password}
                  onChange={(e) => setFormData({...formData, password: e.target.value})}
                  required
                />
              </div>

              <button
                type="submit"
                disabled={isLoading}
                className={`neumorph-button shadow-neumorphism w-full py-3 text-gray-700 font-semibold transition-all ${
                  isLoading ? 'opacity-50 cursor-not-allowed' : 'hover:shadow-neumorphism-inset'
                }`}
              >
                {isLoading ? (
                  <div className="flex items-center justify-center">
                    <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-gray-700 mr-2"></div>
                    Signing in...
                  </div>
                ) : (
                  <div className="flex items-center justify-center">
                    <i className="fas fa-sign-in-alt mr-2"></i>
                    Sign In
                  </div>
                )}
              </button>
            </form>
          </div>
        </div>
      );
    }

    // Stats Cards Component - EXACT SAME
    function StatsCards({ appointments }) {
      const today = new Date().toISOString().split('T')[0];
      
      const stats = {
        total: appointments.length,
        today: appointments.filter(apt => apt.preferred_date === today).length,
        tomorrow: appointments.filter(apt => {
          const tomorrow = new Date();
          tomorrow.setDate(tomorrow.getDate() + 1);
          return apt.preferred_date === tomorrow.toISOString().split('T')[0];
        }).length,
        thisWeek: appointments.filter(apt => {
          const week = new Date();
          week.setDate(week.getDate() + 7);
          return new Date(apt.preferred_date) <= week;
        }).length,
        completed: appointments.filter(apt => apt.status === 'Completed').length,
        pending: appointments.filter(apt => ['Received', 'Contacted'].includes(apt.status)).length
      };

      const statCards = [
        { title: "Total Appointments", value: stats.total, icon: "fas fa-users", color: "text-blue-600", bg: "bg-blue-100" },
        { title: "Today", value: stats.today, icon: "fas fa-calendar-day", color: "text-green-600", bg: "bg-green-100" },
        { title: "Tomorrow", value: stats.tomorrow, icon: "fas fa-clock", color: "text-orange-600", bg: "bg-orange-100" },
        { title: "This Week", value: stats.thisWeek, icon: "fas fa-calendar-week", color: "text-purple-600", bg: "bg-purple-100" },
        { title: "Completed", value: stats.completed, icon: "fas fa-check-circle", color: "text-emerald-600", bg: "bg-emerald-100" },
        { title: "Pending", value: stats.pending, icon: "fas fa-clock", color: "text-yellow-600", bg: "bg-yellow-100" }
      ];

      return (
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
          {statCards.map((stat, index) => (
            <div key={index} className="neumorph-card shadow-neumorphism p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm font-medium text-gray-600">{stat.title}</p>
                  <p className="text-3xl font-bold text-gray-800">{stat.value}</p>
                </div>
                <div className={`p-3 rounded-lg ${stat.bg}`}>
                  <i className={`${stat.icon} ${stat.color} text-xl`}></i>
                </div>
              </div>
            </div>
          ))}
        </div>
      );
    }

    // Appointment List Component - EXACT SAME GUI
    function AppointmentList({ appointments, onSelectAppointment, selectedAppointment }) {
      if (appointments.length === 0) {
        return (
          <div className="text-center py-12 text-gray-500">
            <i className="fas fa-calendar text-6xl mb-4 opacity-30"></i>
            <p>No appointments found</p>
          </div>
        );
      }

      return (
        <div className="space-y-3">
          {appointments.map((appointment) => (
            <div
              key={appointment.id}
              onClick={() => onSelectAppointment(appointment)}
              className={`appointment-card p-4 shadow-neumorphism-sm ${
                selectedAppointment?.id === appointment.id ? 'selected' : ''
              }`}
            >
              <div className="flex justify-between items-start mb-3">
                <div>
                  <h4 className="font-semibold text-gray-800">{appointment.name}</h4>
                  <div className="flex items-center text-sm text-gray-600 mt-1">
                    <i className="fas fa-calendar mr-2"></i>
                    <span>{new Date(appointment.preferred_date).toLocaleDateString()}</span>
                    {appointment.time_window && (
                      <span className="ml-3 px-2 py-1 bg-gray-200 rounded-md text-xs capitalize">
                        {appointment.time_window}
                      </span>
                    )}
                  </div>
                </div>
                <span className={`px-2 py-1 text-xs rounded-full font-medium status-${appointment.status.toLowerCase()}`}>
                  {appointment.status}
                </span>
              </div>
              
              <div className="flex flex-wrap gap-2 mb-3">
                {appointment.tests.slice(0, 3).map((test, index) => (
                  <span key={index} className="text-xs bg-gray-200 text-gray-700 px-2 py-1 rounded">
                    {test}
                  </span>
                ))}
                {appointment.tests.length > 3 && (
                  <span className="text-xs bg-gray-200 text-gray-700 px-2 py-1 rounded">
                    +{appointment.tests.length - 3} more
                  </span>
                )}
              </div>
              
              <div className="flex items-center text-sm text-gray-600">
                {appointment.phone && (
                  <div className="flex items-center mr-4">
                    <i className="fas fa-phone mr-1"></i>
                    <span>{appointment.phone}</span>
                  </div>
                )}
                {appointment.email && (
                  <div className="flex items-center">
                    <i className="fas fa-envelope mr-1"></i>
                    <span className="truncate">{appointment.email}</span>
                  </div>
                )}
              </div>
            </div>
          ))}
        </div>
      );
    }

    // ENHANCED Appointment Detail Component - SAME GUI + PATIENT DETAILS + PRESCRIPTION
    function AppointmentDetail({ appointment, onStatusUpdate }) {
      const [newStatus, setNewStatus] = useState("");
      const [adminNotes, setAdminNotes] = useState("");
      const [isUpdating, setIsUpdating] = useState(false);

      useEffect(() => {
        if (appointment) {
          setNewStatus(appointment.status);
          setAdminNotes(appointment.admin_notes || "");
        }
      }, [appointment]);

      const handleStatusUpdate = async () => {
        if (!appointment || isUpdating) return;

        setIsUpdating(true);
        try {
          await onStatusUpdate(appointment.id, newStatus, adminNotes);
          alert('Status updated successfully!');
        } catch (error) {
          alert('Failed to update status');
        }
        setIsUpdating(false);
      };

      const openPrescriptionModal = (imageUrl) => {
        const modal = document.createElement('div');
        modal.className = 'prescription-modal show';
        modal.innerHTML = `
          <div class="prescription-viewer p-6">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-xl font-semibold text-gray-800">Prescription Document</h3>
              <button onclick="this.closest('.prescription-modal').remove()" class="text-gray-500 hover:text-gray-700 text-2xl">×</button>
            </div>
            <div class="text-center">
              <img src="${imageUrl}" alt="Prescription" class="prescription-image">
            </div>
            <div class="flex justify-center gap-3 mt-4">
              <button onclick="window.open('${imageUrl}', '_blank')" class="neumorph-button shadow-neumorphism px-4 py-2 text-gray-700">
                <i class="fas fa-external-link-alt mr-2"></i>Open Full Size
              </button>
              <button onclick="downloadPrescription('${imageUrl}')" class="neumorph-button shadow-neumorphism px-4 py-2 text-gray-700">
                <i class="fas fa-download mr-2"></i>Download
              </button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      };

      if (!appointment) {
        return (
          <div className="text-center py-12 text-gray-500">
            <i className="fas fa-file-alt text-6xl mb-4 opacity-30"></i>
            <p>Select an appointment to view details</p>
          </div>
        );
      }

      const fullAddress = [
        appointment.address_house_no, appointment.address_house_name, appointment.address_street,
        appointment.address_locality, appointment.address_city, appointment.address_state, appointment.address_pincode
      ].filter(Boolean).join(', ');

      return (
        <div className="space-y-6">
          {/* Header - SAME */}
          <div className="flex justify-between items-start">
            <div>
              <h3 className="text-xl font-semibold text-gray-800">{appointment.name}</h3>
              <p className="text-sm text-gray-600">Created {new Date(appointment.created_date).toLocaleDateString()}</p>
            </div>
            <span className={`px-3 py-1 text-sm rounded-full font-medium status-${appointment.status.toLowerCase()}`}>
              {appointment.status}
            </span>
          </div>

          {/* ENHANCED PATIENT DETAILS SECTION */}
          <div className="space-y-4">
            <h4 className="font-semibold text-gray-800 flex items-center">
              <i className="fas fa-user mr-2"></i> Complete Patient Information
            </h4>
            
            <div className="patient-detail-grid">
              <div className="patient-detail-item">
                <div className="patient-detail-label">Full Name</div>
                <div className="patient-detail-value">{appointment.name}</div>
              </div>
              
              <div className="patient-detail-item">
                <div className="patient-detail-label">Phone Number</div>
                <div className="patient-detail-value">{appointment.phone || 'Not provided'}</div>
              </div>
              
              <div className="patient-detail-item">
                <div className="patient-detail-label">Email Address</div>
                <div className="patient-detail-value">{appointment.email || 'Not provided'}</div>
              </div>
              
              <div className="patient-detail-item">
                <div className="patient-detail-label">Age</div>
                <div className="patient-detail-value">{appointment.age || 'Not specified'} years</div>
              </div>
              
              <div className="patient-detail-item">
                <div className="patient-detail-label">Gender</div>
                <div className="patient-detail-value">{appointment.gender || 'Not specified'}</div>
              </div>
              
              <div className="patient-detail-item">
                <div className="patient-detail-label">Booking ID</div>
                <div className="patient-detail-value">{appointment.id.substring(0, 8).toUpperCase()}</div>
              </div>
            </div>
          </div>

          {/* Contact Information - ENHANCED */}
          <div className="space-y-3">
            <h4 className="font-semibold text-gray-800 flex items-center">
              <i className="fas fa-address-book mr-2"></i> Contact Information
            </h4>
            <div className="bg-gray-50 p-4 rounded-lg space-y-2">
              {appointment.phone && (
                <p className="text-sm flex items-center">
                  <i className="fas fa-phone mr-3 text-green-600"></i>
                  <span className="font-medium">Phone:</span>
                  <span className="ml-2">{appointment.phone}</span>
                  <button onClick={() => window.open(`tel:${appointment.phone}`)} className="ml-2 text-green-600 hover:text-green-800">
                    <i className="fas fa-phone-alt"></i>
                  </button>
                </p>
              )}
              {appointment.email && (
                <p className="text-sm flex items-center">
                  <i className="fas fa-envelope mr-3 text-blue-600"></i>
                  <span className="font-medium">Email:</span>
                  <span className="ml-2">{appointment.email}</span>
                  <button onClick={() => window.open(`mailto:${appointment.email}`)} className="ml-2 text-blue-600 hover:text-blue-800">
                    <i className="fas fa-envelope-open"></i>
                  </button>
                </p>
              )}
              {appointment.emergency_contact && (
                <p className="text-sm flex items-center">
                  <i className="fas fa-exclamation-triangle mr-3 text-red-600"></i>
                  <span className="font-medium">Emergency Contact:</span>
                  <span className="ml-2">{appointment.emergency_contact}</span>
                </p>
              )}
            </div>
          </div>

          {/* Appointment Details - ENHANCED */}
          <div className="space-y-3">
            <h4 className="font-semibold text-gray-800 flex items-center">
              <i className="fas fa-calendar mr-2"></i> Appointment Details
            </h4>
            <div className="bg-gray-50 p-4 rounded-lg space-y-2">
              <p className="text-sm flex items-center">
                <i className="fas fa-calendar-day mr-3 text-purple-600"></i>
                <span className="font-medium">Collection Date:</span>
                <span className="ml-2">{new Date(appointment.preferred_date).toDateString()}</span>
              </p>
              {appointment.time_window && (
                <p className="text-sm flex items-center">
                  <i className="fas fa-clock mr-3 text-orange-600"></i>
                  <span className="font-medium">Time Slot:</span>
                  <span className="ml-2 capitalize">{appointment.time_window}</span>
                </p>
              )}
              <p className="text-sm flex items-center">
                <i className="fas fa-home mr-3 text-indigo-600"></i>
                <span className="font-medium">Collection Type:</span>
                <span className="ml-2">{appointment.collection_type || 'Home Collection'}</span>
              </p>
            </div>
          </div>

          {/* Tests - ENHANCED */}
          <div className="space-y-3">
            <h4 className="font-semibold text-gray-800 flex items-center">
              <i className="fas fa-vial mr-2"></i> Tests Required
            </h4>
            <div className="bg-gray-50 p-4 rounded-lg">
              <div className="flex flex-wrap gap-2">
                {appointment.tests.map((test, index) => (
                  <span key={index} className="text-sm bg-blue-100 text-blue-800 px-3 py-1 rounded-full font-medium">
                    <i className="fas fa-flask mr-1"></i>{test}
                  </span>
                ))}
              </div>
              {appointment.fasting_required && (
                <div className="mt-3 p-2 bg-yellow-100 border border-yellow-300 rounded-lg">
                  <p className="text-sm text-yellow-800 flex items-center">
                    <i className="fas fa-exclamation-circle mr-2"></i>
                    <strong>Important:</strong> Fasting required for {appointment.fasting_hours || '12'} hours
                  </p>
                </div>
              )}
            </div>
          </div>

          {/* Address - ENHANCED */}
          {fullAddress && (
            <div className="space-y-3">
              <h4 className="font-semibold text-gray-800 flex items-center">
                <i className="fas fa-map-marker-alt mr-2"></i> Collection Address
              </h4>
              <div className="bg-gray-50 p-4 rounded-lg">
                <p className="text-sm text-gray-700">{fullAddress}</p>
                {(appointment.address_landmark || appointment.address_instructions) && (
                  <div className="mt-2 pt-2 border-t border-gray-200">
                    {appointment.address_landmark && (
                      <p className="text-xs text-gray-600">
                        <i className="fas fa-map-pin mr-1"></i>
                        <strong>Landmark:</strong> {appointment.address_landmark}
                      </p>
                    )}
                    {appointment.address_instructions && (
                      <p className="text-xs text-gray-600 mt-1">
                        <i className="fas fa-info-circle mr-1"></i>
                        <strong>Instructions:</strong> {appointment.address_instructions}
                      </p>
                    )}
                  </div>
                )}
              </div>
            </div>
          )}

          {/* Patient Notes - ENHANCED */}
          {appointment.notes && (
            <div className="space-y-3">
              <h4 className="font-semibold text-gray-800">Patient Notes</h4>
              <div className="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-400">
                <p className="text-sm text-blue-800">{appointment.notes}</p>
              </div>
            </div>
          )}

          {/* PRESCRIPTION SECTION - ENHANCED */}
          <div className="space-y-3">
            <h4 className="font-semibold text-gray-800 flex items-center">
              <i className="fas fa-prescription mr-2"></i> Prescription/Documents
            </h4>
            <div className="bg-gray-50 p-4 rounded-lg">
              {appointment.prescriptionImage ? (
                <div className="space-y-3">
                  <div className="flex items-center justify-between">
                    <div className="flex items-center">
                      <i className="fas fa-file-image text-green-600 mr-2"></i>
                      <span className="text-sm font-medium text-gray-700">Prescription Available</span>
                    </div>
                    <div className="flex gap-2">
                      <button 
                        onClick={() => openPrescriptionModal(appointment.prescriptionImage)}
                        className="neumorph-button shadow-neumorphism-sm px-3 py-1 text-xs text-gray-600 hover:shadow-neumorphism-inset"
                      >
                        <i className="fas fa-eye mr-1"></i>View
                      </button>
                      <button 
                        onClick={() => window.open(appointment.prescriptionImage, '_blank')}
                        className="neumorph-button shadow-neumorphism-sm px-3 py-1 text-xs text-gray-600 hover:shadow-neumorphism-inset"
                      >
                        <i className="fas fa-external-link-alt mr-1"></i>Open
                      </button>
                      <button 
                        onClick={() => {
                          const link = document.createElement('a');
                          link.href = appointment.prescriptionImage;
                          link.download = `prescription-${appointment.id}.jpg`;
                          link.click();
                        }}
                        className="neumorph-button shadow-neumorphism-sm px-3 py-1 text-xs text-gray-600 hover:shadow-neumorphism-inset"
                      >
                        <i className="fas fa-download mr-1"></i>Download
                      </button>
                    </div>
                  </div>
                  
                  <div className="border-2 border-dashed border-gray-300 rounded-lg p-2">
                    <img 
                      src={appointment.prescriptionImage} 
                      alt="Prescription" 
                      className="w-full h-32 object-cover cursor-pointer rounded"
                      onClick={() => openPrescriptionModal(appointment.prescriptionImage)}
                      onError={(e) => {
                        console.log('Image failed to load:', appointment.prescriptionImage);
                        e.target.style.display = 'none';
                        e.target.nextElementSibling.style.display = 'block';
                      }}
                    />
                    <div className="text-center py-4 text-gray-500 hidden">
                      <i className="fas fa-exclamation-triangle text-xl mb-2"></i>
                      <p className="text-sm">Failed to load prescription image</p>
                    </div>
                  </div>
                </div>
              ) : (
                <div className="prescription-placeholder">
                  <i className="fas fa-upload text-4xl mb-3 opacity-50"></i>
                  <p className="text-sm mb-2">No prescription uploaded</p>
                  <p className="text-xs opacity-75">Prescription documents will appear here when uploaded during booking</p>
                </div>
              )}
            </div>
          </div>


          {/* Medical History - NEW SECTION */}
          {(appointment.medical_conditions || appointment.current_medications || appointment.allergies) && (
            <div className="space-y-3">
              <h4 className="font-semibold text-gray-800 flex items-center">
                <i className="fas fa-heartbeat mr-2"></i> Medical Information
              </h4>
              <div className="bg-red-50 p-4 rounded-lg space-y-2">
                {appointment.medical_conditions && (
                  <p className="text-sm">
                    <strong className="text-red-800">Conditions:</strong>
                    <span className="ml-2 text-red-700">{appointment.medical_conditions}</span>
                  </p>
                )}
                {appointment.current_medications && (
                  <p className="text-sm">
                    <strong className="text-red-800">Medications:</strong>
                    <span className="ml-2 text-red-700">{appointment.current_medications}</span>
                  </p>
                )}
                {appointment.allergies && (
                  <p className="text-sm">
                    <strong className="text-red-800">Allergies:</strong>
                    <span className="ml-2 text-red-700">{appointment.allergies}</span>
                  </p>
                )}
              </div>
            </div>
          )}

          {/* Status Update - SAME GUI */}
          <div className="space-y-3 pt-4 border-t border-gray-200">
            <h4 className="font-semibold text-gray-800">Update Status</h4>
            <div className="space-y-3">
              <select
                value={newStatus}
                onChange={(e) => setNewStatus(e.target.value)}
                className="neumorph-input shadow-neumorphism-inset-sm w-full px-4 py-2 focus:outline-none"
              >
                <option value="Received">Received</option>
                <option value="Contacted">Contacted</option>
                <option value="Confirmed">Confirmed</option>
                <option value="Completed">Completed</option>
                <option value="Cancelled">Cancelled</option>
              </select>
              
              <textarea
                value={adminNotes}
                onChange={(e) => setAdminNotes(e.target.value)}
                className="neumorph-input shadow-neumorphism-inset-sm w-full px-4 py-2 min-h-20 focus:outline-none"
                placeholder="Add admin notes..."
              />
              
              <button
                onClick={handleStatusUpdate}
                disabled={isUpdating}
                className={`neumorph-button shadow-neumorphism w-full py-3 text-gray-700 font-semibold transition-all ${
                  isUpdating ? 'opacity-50 cursor-not-allowed' : 'hover:shadow-neumorphism-inset'
                }`}
              >
                {isUpdating ? (
                  <div className="flex items-center justify-center">
                    <div className="animate-spin rounded-full h-5 w-5 border-b-2 border-gray-700 mr-2"></div>
                    Updating...
                  </div>
                ) : (
                  <div className="flex items-center justify-center">
                    <i className="fas fa-save mr-2"></i>
                    Update Appointment
                  </div>
                )}
              </button>
            </div>
          </div>
        </div>
      );
    }

    // Main Admin Dashboard - EXACT SAME STRUCTURE
    function AdminDashboard() {
      const [user, setUser] = useState(null);
      const [appointments, setAppointments] = useState([]);
      const [filteredAppointments, setFilteredAppointments] = useState([]);
      const [selectedAppointment, setSelectedAppointment] = useState(null);
      const [searchTerm, setSearchTerm] = useState("");
      const [statusFilter, setStatusFilter] = useState("all");
      const [isLoading, setIsLoading] = useState(true);

      useEffect(() => {
        const token = sessionStorage.getItem('adminSessionId');
        if (token) {
          checkUser();
        } else {
          setIsLoading(false);
        }
      }, []);

      const checkUser = async () => {
        try {
          setUser({ name: 'Admin', email: 'admin@pathlab.com' });
          await loadAppointments();
        } catch (error) {
          sessionStorage.removeItem('adminSessionId');
        }
        setIsLoading(false);
      };

      const loadAppointments = async () => {
          try {
              const sessionId = sessionStorage.getItem('adminSessionId'); // New session approach
              const response = await fetch('/api/admin/appointments', {
                  headers: {
                      'X-Session-ID': sessionId // Session header
                  }
              });

          if (response.ok) {
            const result = await response.json();
            if (result.success) {
              const transformedAppointments = result.data.appointments.map(apt => ({
                id: apt.id,
                name: apt.customer.fullName,
                phone: apt.customer.phone,
                email: apt.customer.email,
                preferred_date: apt.collectionDate.split('T')[0],
                time_window: apt.timeSlot || 'morning',
                tests: apt.tests ? apt.tests.split(',').map(t => t.trim()) : [],
                status: apt.status || 'Received',
                created_date: apt.createdAt,
                notes: apt.notes || '',
                admin_notes: '',
                prescriptionImage: apt.prescriptionImage,
                // ENHANCED PATIENT DATA
                age: apt.customer.age,
                gender: apt.customer.gender,
                medical_conditions: apt.customer.medical_conditions,
                current_medications: apt.customer.current_medications,
                allergies: apt.customer.allergies,
                emergency_contact: apt.customer.emergency_contact,
                fasting_required: apt.fasting_required,
                fasting_hours: apt.fasting_hours,
                collection_type: apt.collection_type,
                // ADDRESS DATA
                address_house_no: apt.address_house_no || '',
                address_house_name: apt.address_house_name || '',
                address_street: apt.address_street || '',
                address_locality: apt.address_locality || '',
                address_city: apt.address_city || '',
                address_state: apt.address_state || '',
                address_pincode: apt.address_pincode || '',
                address_landmark: apt.address_landmark || '',
                address_instructions: apt.address_instructions || '',
                // PRESCRIPTION DATA
                prescription_url: apt.prescription_url
              }));
              
              setAppointments(transformedAppointments);
              setFilteredAppointments(transformedAppointments);
              return;
            }
          }
        } catch (error) {
          console.error('Failed to load appointments:', error);
        }

        // ENHANCED SAMPLE DATA WITH ALL DETAILS
        const sampleData = generateEnhancedSampleData();
        setAppointments(sampleData);
        setFilteredAppointments(sampleData);
      };

      const generateEnhancedSampleData = () => {
        const statuses = ['Received', 'Contacted', 'Confirmed', 'Completed', 'Cancelled'];
        const tests = [['CBC'], ['LFT'], ['KFT'], ['Lipid Profile'], ['Thyroid Profile'], ['HbA1c'], ['CBC', 'LFT'], ['ESR', 'CRP']];
        const names = ['John Doe', 'Jane Smith', 'Mike Johnson', 'Sarah Wilson', 'David Brown', 'Lisa Garcia'];
        const cities = ['Mumbai', 'Delhi', 'Bangalore', 'Chennai', 'Kolkata', 'Pune'];
        
        return Array.from({length: 12}, (_, i) => ({
          id: `apt${i + 1}`,
          name: names[i % names.length],
          phone: `+91${Math.floor(Math.random() * 9000000000) + 1000000000}`,
          email: `user${i + 1}@example.com`,
          preferred_date: new Date(Date.now() + (Math.random() - 0.5) * 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
          time_window: ['morning', 'afternoon', 'evening'][Math.floor(Math.random() * 3)],
          tests: tests[Math.floor(Math.random() * tests.length)],
          status: statuses[Math.floor(Math.random() * statuses.length)],
          created_date: new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000).toISOString(),
          notes: Math.random() > 0.5 ? 'Patient has specific requirements for early morning collection' : '',
          admin_notes: Math.random() > 0.7 ? 'Follow up required - patient called' : '',
          // ENHANCED PATIENT DATA
          age: Math.floor(Math.random() * 60) + 20,
          gender: Math.random() > 0.5 ? 'Male' : 'Female',
          medical_conditions: Math.random() > 0.7 ? 'Diabetes, Hypertension' : '',
          current_medications: Math.random() > 0.8 ? 'Metformin 500mg, Lisinopril 10mg' : '',
          allergies: Math.random() > 0.9 ? 'Penicillin, Shellfish' : '',
          emergency_contact: `+91${Math.floor(Math.random() * 9000000000) + 1000000000}`,
          fasting_required: Math.random() > 0.6,
          fasting_hours: 12,
          collection_type: 'Home Collection',
          // ADDRESS DATA
          address_house_no: Math.floor(Math.random() * 999) + 1,
          address_house_name: Math.random() > 0.5 ? 'Apartment Complex' : '',
          address_street: 'Main Street',
          address_locality: 'City Center',
          address_city: cities[Math.floor(Math.random() * cities.length)],
          address_state: 'Maharashtra',
          address_pincode: `4${Math.floor(Math.random() * 9)}00${Math.floor(Math.random() * 99)}`,
          address_landmark: Math.random() > 0.6 ? 'Near City Hospital' : '',
          address_instructions: Math.random() > 0.7 ? 'Ring doorbell twice, building gate code: 1234' : '',
          // PRESCRIPTION DATA
          prescription_url: Math.random() > 0.4 ? `data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="300" height="200"><rect width="300" height="200" fill="%23f8f9fa"/><text x="50%" y="50%" text-anchor="middle" dy=".35em" font-family="Arial" font-size="14" fill="%236c757d">Sample Prescription ${i + 1}</text></svg>` : null
        }));
      };

      // Filter appointments
      useEffect(() => {
        let filtered = appointments;

        if (searchTerm) {
          filtered = filtered.filter(apt =>
            apt.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
            apt.phone?.includes(searchTerm) ||
            apt.email?.toLowerCase().includes(searchTerm.toLowerCase())
          );
        }

        if (statusFilter !== 'all') {
          filtered = filtered.filter(apt => apt.status === statusFilter);
        }

        setFilteredAppointments(filtered);
      }, [searchTerm, statusFilter, appointments]);

      const handleLogin = (userData) => {
        setUser(userData);
        loadAppointments();
      };

      const handleLogout = () => {
        sessionStorage.removeItem('adminSessionId');
        setUser(null);
      };

      const handleStatusUpdate = async (appointmentId, newStatus, adminNotes) => {
          try {
              const token = sessionStorage.getItem('adminSessionId');
              
              // 🚀 CALL BACKEND API FIRST
              const response = await fetch('/api/admin/update-status', {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                      'Authorization': `Bearer ${token}`
                  },
                  body: JSON.stringify({
                      appointmentId: appointmentId,
                      status: newStatus,
                      notes: adminNotes
                  })
              });
              
              const result = await response.json();
              
              if (response.ok && result.success) {
                  // ✅ UPDATE UI AFTER SUCCESSFUL API CALL
                  const updatedAppointments = appointments.map(apt =>
                    apt.id === appointmentId
                      ? { ...apt, status: newStatus, admin_notes: adminNotes }
                      : apt
                  );
                  
                  setAppointments(updatedAppointments);
                  setSelectedAppointment(prev => 
                    prev?.id === appointmentId 
                      ? { ...prev, status: newStatus, admin_notes: adminNotes }
                      : prev
                  );
                  
                  alert('✅ Status updated successfully!');
              } else {
                  alert('❌ Failed to update status: ' + result.message);
              }
          } catch (error) {
              console.error('Status update error:', error);
              alert('❌ Error updating status');
          }
      };


      if (isLoading) {
        return (
          <div className="min-h-screen flex items-center justify-center">
            <div className="animate-spin rounded-full h-16 w-16 border-b-2 border-blue-500"></div>
          </div>
        );
      }

      if (!user) {
        return <LoginScreen onLogin={handleLogin} />;
      }

      return (
        <div className="min-h-screen bg-gray-100">
          {/* Header - EXACT SAME */}
          <div className="bg-white shadow-sm border-b">
            <div className="px-6 py-4 flex justify-between items-center">
              <div>
                <h1 className="text-2xl font-bold text-gray-900 flex items-center">
                  <span className="mr-3">🔬</span>
                  PathLab Connect - Admin Dashboard
                </h1>
                <p className="text-gray-600">Manage lab appointments and bookings</p>
              </div>
              <div className="flex items-center space-x-4">
                <span className="text-sm text-gray-600">Welcome, {user.name}</span>
                <button
                  onClick={handleLogout}
                  className="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors"
                >
                  <i className="fas fa-sign-out-alt mr-2"></i>Logout
                </button>
              </div>
            </div>
          </div>

          <div className="p-6">
            {/* Stats Cards - EXACT SAME */}
            <StatsCards appointments={appointments} />

            {/* Filters - EXACT SAME */}
            <div className="neumorph-card shadow-neumorphism p-6 mb-8">
              <h3 className="text-lg font-semibold text-gray-800 mb-4">Filters & Search</h3>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Search</label>
                  <input
                    type="text"
                    className="neumorph-input shadow-neumorphism-inset-sm w-full px-4 py-2 focus:outline-none"
                    placeholder="Name, phone, email..."
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Status</label>
                  <select
                    className="neumorph-input shadow-neumorphism-inset-sm w-full px-4 py-2 focus:outline-none"
                    value={statusFilter}
                    onChange={(e) => setStatusFilter(e.target.value)}
                  >
                    <option value="all">All Statuses</option>
                    <option value="Received">Received</option>
                    <option value="Contacted">Contacted</option>
                    <option value="Confirmed">Confirmed</option>
                    <option value="Completed">Completed</option>
                    <option value="Cancelled">Cancelled</option>
                  </select>
                </div>
                <div className="flex items-end">
                  <button
                    onClick={() => {
                      setSearchTerm('');
                      setStatusFilter('all');
                    }}
                    className="neumorph-button shadow-neumorphism w-full py-2 text-gray-700 hover:shadow-neumorphism-inset transition-all"
                  >
                    <i className="fas fa-times mr-2"></i>Clear Filters
                  </button>
                </div>
              </div>
            </div>

            {/* Main Content - SAME LAYOUT */}
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
              {/* Appointments List - SAME */}
              <div className="neumorph-card shadow-neumorphism p-6">
                <h3 className="text-lg font-semibold text-gray-800 mb-4">
                  Appointments ({filteredAppointments.length})
                </h3>
                <div className="max-h-96 overflow-y-auto">
                  <AppointmentList
                    appointments={filteredAppointments}
                    onSelectAppointment={setSelectedAppointment}
                    selectedAppointment={selectedAppointment}
                  />
                </div>
              </div>

              {/* Appointment Details - ENHANCED WITH PATIENT DETAILS + PRESCRIPTION */}
              <div className="neumorph-card shadow-neumorphism p-6">
                <h3 className="text-lg font-semibold text-gray-800 mb-4">Patient & Appointment Details</h3>
                <div className="max-h-96 overflow-y-auto">
                  <AppointmentDetail
                    appointment={selectedAppointment}
                    onStatusUpdate={handleStatusUpdate}
                  />
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    }

    // Render the app
    ReactDOM.render(<AdminDashboard />, document.getElementById('root'));

    // Global prescription download function
    window.downloadPrescription = (url) => {
      const link = document.createElement('a');
      link.href = url;
      link.download = 'prescription-' + Date.now() + '.jpg';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    };
  </script>
</body>
</html>
